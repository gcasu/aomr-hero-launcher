<app-page-container containerClass="with-side-padding">
  <app-page-header 
    [title]="'BUILD_ORDERS.TITLE' | translate"
    [description]="'BUILD_ORDERS.DESCRIPTION' | translate">
  </app-page-header>

  <app-loading-state *ngIf="isLoading"></app-loading-state>

  <div *ngIf="!isLoading" class="build-orders-content">
    <!-- Major God Selection -->
    <div class="god-selection-section">
      <h3 class="section-title">{{ 'BUILD_ORDERS.SELECT_MAJOR_GOD' | translate }}</h3>
      <div class="gods-container">
        <div class="god-item" 
             *ngFor="let god of majorGods; trackBy: trackByGod"
             [class.selected]="isGodSelected(god.id)"
             (click)="onGodSelect(god)"
             [attr.data-god-id]="god.id">
          <img 
            [src]="god.imagePath" 
            [alt]="god.name"
            [title]="god.name"
            (error)="onImageError($event)"
            loading="lazy">
          <span class="god-name">{{ god.name }}</span>
        </div>
      </div>
    </div>

    <!-- Match History Table -->
    <div id="match-history-section" class="match-history-section" *ngIf="selectedGodId">
      <div class="section-header">
        <h3 class="section-title">{{ getSelectedGodMatchTitle() }}</h3>
        <div *ngIf="hasGodMatches()" class="match-count-text">
          <small class="text-light">
            {{ getMatchCountText() }}
          </small>
        </div>
      </div>
      
      <!-- Search Bar (only visible if there are matches for the god) -->
      <div *ngIf="hasGodMatches()">
        <app-search-filter 
          [placeholder]="'BUILD_ORDERS.SEARCH_PLACEHOLDER'"
          [fullWidth]="false"
          [(ngModel)]="searchTerm"
          (filterChange)="onSearchChange()">
        </app-search-filter>
      </div>
      
      <div class="match-history-table-container">
        <!-- Empty State for no matches for this god -->
        <div *ngIf="!hasGodMatches()">
          <app-empty-state 
            [title]="'BUILD_ORDERS.NO_MATCHES_TITLE' | translate"
            [description]="'BUILD_ORDERS.NO_MATCHES_DESCRIPTION' | translate"
            icon="fas fa-history">
          </app-empty-state>
        </div>

        <!-- Empty State for no search results -->
        <div *ngIf="isSearchFiltered()">
          <app-empty-state 
            [title]="'BUILD_ORDERS.NO_RESULTS_TITLE' | translate"
            [description]="'BUILD_ORDERS.NO_RESULTS_DESCRIPTION' | translate"
            icon="fas fa-search">
          </app-empty-state>
        </div>

        <!-- Matches Table -->
        <div *ngIf="filteredMatches.length > 0" class="table-responsive">
          <table class="table table-dark table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th scope="col" class="sortable-header" 
                    (click)="onSort('winningPlayer')"
                    [class.sorted]="isSortedBy('winningPlayer')">
                  {{ 'BUILD_ORDERS.TABLE.PLAYER' | translate }}
                  <i [class]="getSortIcon('winningPlayer')" class="ms-1"></i>
                </th>
                <th scope="col" class="text-center sortable-header" 
                    (click)="onSort('matchDate')"
                    [class.sorted]="isSortedBy('matchDate')">
                  {{ 'BUILD_ORDERS.TABLE.MATCH_DATE' | translate }}
                  <i [class]="getSortIcon('matchDate')" class="ms-1"></i>
                </th>
                <th scope="col" class="text-center sortable-header" 
                    (click)="onSort('mapType')"
                    [class.sorted]="isSortedBy('mapType')">
                  {{ 'BUILD_ORDERS.TABLE.MAP' | translate }}
                  <i [class]="getSortIcon('mapType')" class="ms-1"></i>
                </th>
                <th scope="col" class="text-center">{{ 'BUILD_ORDERS.TABLE.ACTIONS' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let match of filteredMatches; trackBy: trackByMatch" class="match-row">
                <!-- Player (Avatar + Name) -->
                <td class="leader-cell">
                  <div class="leader-info">
                    <img 
                      [src]="match.winningPlayerAvatar" 
                      [alt]="match.winningPlayer"
                      class="player-avatar"
                      (error)="onImageError($event)"
                      loading="lazy">
                    <span class="player-name clickable" 
                          (click)="onFilterByPlayer(match.winningPlayer)"
                          [title]="'Click to filter by ' + match.winningPlayer">
                      {{ match.winningPlayer }}
                    </span>
                  </div>
                </td>
                
                <!-- Match Date -->
                <td class="text-center match-date-cell">
                  <span class="match-date">{{ formatDate(match.matchDate) | date:'dd MMMM yy, HH:mm' }}</span>
                </td>
                
                <!-- Map -->
                <td class="text-center map-cell">
                  <span class="map-name clickable" 
                        (click)="onFilterByMap(match.mapType)"
                        [title]="'Click to filter by ' + formatMapName(match.mapType)">
                    {{ formatMapName(match.mapType) }}
                  </span>
                </td>
                
                <!-- Actions -->
                <td class="text-center actions-cell">
                  <div class="action-buttons">
                    <!-- If not cached, show analyze button -->
                    <ng-container *ngIf="!isReplayCached(match)">
                      <button 
                        type="button" 
                        class="btn btn-outline-primary btn-sm"
                        [disabled]="isAnalyzingReplay"
                        (click)="analyzeReplay(match)"
                        [title]="'BUILD_ORDERS.REPLAY.ANALYZE_TOOLTIP' | translate">
                        <span *ngIf="isMatchBeingAnalyzed(match.matchId)" class="spinner-border spinner-border-sm" role="status"></span>
                        <i *ngIf="!isMatchBeingAnalyzed(match.matchId)" class="fas fa-chart-line"></i>
                      </button>
                    </ng-container>

                    <!-- If cached, show action buttons based on success/error state -->
                    <ng-container *ngIf="isReplayCached(match)">
                      <!-- Download Replay File (always available) -->
                      <button 
                        type="button" 
                        class="btn btn-outline-success btn-sm me-1"
                        (click)="downloadReplayFile(match)"
                        [title]="'BUILD_ORDERS.REPLAY.DOWNLOAD_REPLAY_TOOLTIP' | translate">
                        <i class="fas fa-download"></i>
                      </button>

                      <!-- Download JSON (only if analysis was successful) -->
                      <button 
                        *ngIf="isReplayCacheSuccessful(match)"
                        type="button" 
                        class="btn btn-outline-info btn-sm me-1"
                        (click)="downloadReplayJson(match)"
                        [title]="'BUILD_ORDERS.REPLAY.DOWNLOAD_JSON_TOOLTIP' | translate">
                        <i class="fas fa-file-code"></i>
                      </button>

                      <!-- Show Timeline (only if analysis was successful) -->
                      <button 
                        *ngIf="isReplayCacheSuccessful(match)"
                        type="button" 
                        class="btn btn-outline-primary btn-sm"
                        (click)="showCachedTimeline(match)"
                        [title]="'BUILD_ORDERS.REPLAY.SHOW_TIMELINE_TOOLTIP' | translate">
                        <i class="fas fa-chart-line"></i>
                      </button>

                      <!-- Error indicator (only if analysis failed) -->
                      <button 
                        *ngIf="hasReplayCacheError(match)"
                        type="button" 
                        class="btn btn-outline-danger btn-sm"
                        disabled
                        [title]="'BUILD_ORDERS.REPLAY.ANALYSIS_FAILED' | translate">
                        <i class="fas fa-exclamation-triangle"></i>
                      </button>
                    </ng-container>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Timeline Analysis Section -->
    <div *ngIf="showTimeline" class="timeline-analysis-section mt-4">
      <div class="section-header">
        <h3 class="section-title">{{ 'BUILD_ORDERS.REPLAY.WINNER_TIMELINE' | translate }}</h3>
        <div class="d-flex align-items-center">
          <small class="text-light me-3">
            {{ winnerPlayerName }} - {{ 'COMMON.MATCH' | translate }} {{ analysisMatchId }}
          </small>
          <button 
            type="button" 
            class="btn btn-outline-light btn-sm"
            (click)="closeTimeline()">
            <i class="fas fa-times me-1"></i>
            {{ 'BUILD_ORDERS.REPLAY.CLOSE_TIMELINE' | translate }}
          </button>
        </div>
      </div>
      
      <app-glass-card cardClass="padded">
        <app-timeline 
          [segments]="timelineData"
          [playerName]="winnerPlayerName"
          [playerColor]="getPlayerColorForTimeline(1)"
          [compact]="false">
        </app-timeline>
      </app-glass-card>
    </div>
  </div>
</app-page-container>
