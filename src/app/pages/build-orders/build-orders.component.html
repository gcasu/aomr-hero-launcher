<app-page-container containerClass="with-side-padding">
  <app-page-header 
    [title]="'BUILD_ORDERS.TITLE' | translate"
    [description]="'BUILD_ORDERS.DESCRIPTION' | translate">
  </app-page-header>

  <app-loading-state *ngIf="isLoading"></app-loading-state>

  <div *ngIf="!isLoading" class="build-orders-content">
    <!-- Major God Selection -->
    <div class="god-selection-section">
      <h3 class="section-title">{{ 'BUILD_ORDERS.SELECT_MAJOR_GOD' | translate }}</h3>
      <div class="gods-container">
        <div class="god-item" 
             *ngFor="let god of majorGods; trackBy: trackByGod"
             [class.selected]="isGodSelected(god.id)"
             (click)="onGodSelect(god)"
             [attr.data-god-id]="god.id">
          <img 
            [src]="god.imagePath" 
            [alt]="god.name"
            [title]="god.name"
            (error)="onImageError($event)"
            loading="lazy">
          <span class="god-name">{{ god.name }}</span>
        </div>
      </div>
    </div>

    <!-- Tab Buttons View Start -->
    <div class="custom-tabs-section" *ngIf="selectedGodId">
      <div class="tab-headers">
        <button 
          class="tab-button" 
          [class.active]="activeTabId === 'top-rank-matches'"
          (click)="onTabChange('top-rank-matches')">
          {{ 'BUILD_ORDERS.TABS.TOP_RANK_MATCHES' | translate }}
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTabId === 'dod-clan-build-orders'"
          (click)="onTabChange('dod-clan-build-orders')">
          {{ 'BUILD_ORDERS.TABS.DOD_CLAN_BUILD_ORDERS' | translate }}
        </button>
      </div>
    </div>
    <!-- Tab Buttons View End -->

    <!-- Match History Table Start -->
    <div *ngIf="activeTabId === 'top-rank-matches' && selectedGodId" class="tab-panel">
      <div id="match-history-section" class="match-history-section">
        <div class="section-header">
          <h3 class="section-title">{{ getSelectedGodMatchTitle() }}</h3>
          <div *ngIf="hasGodMatches()" class="match-count-text">
            <small class="text-light">
              {{ getMatchCountText() }}
            </small>
          </div>
        </div>
        
        <!-- Search Bar (only visible if there are matches for the god) -->
        <div *ngIf="hasGodMatches()">
          <app-search-filter 
            [placeholder]="'BUILD_ORDERS.SEARCH_PLACEHOLDER'"
            [fullWidth]="false"
            [(ngModel)]="searchTerm"
            (filterChange)="onSearchChange()">
          </app-search-filter>
        </div>
        
        <div class="match-history-table-container">
          <!-- Empty State for no matches for this god -->
          <div *ngIf="!hasGodMatches()">
            <app-empty-state 
              [title]="'BUILD_ORDERS.NO_MATCHES_TITLE' | translate"
              [description]="'BUILD_ORDERS.NO_MATCHES_DESCRIPTION' | translate"
              icon="fas fa-history">
            </app-empty-state>
          </div>

          <!-- Empty State for no search results -->
          <div *ngIf="isSearchFiltered()">
            <app-empty-state 
              [title]="'BUILD_ORDERS.NO_RESULTS_TITLE' | translate"
              [description]="'BUILD_ORDERS.NO_RESULTS_DESCRIPTION' | translate"
              icon="fas fa-search">
            </app-empty-state>
          </div>

          <!-- Matches Table -->
          <div *ngIf="filteredMatches.length > 0" class="table-responsive">
            <table class="table table-dark table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th scope="col" class="sortable-header" 
                      (click)="onSort('winningPlayer')"
                      [class.sorted]="isSortedBy('winningPlayer')">
                    {{ 'BUILD_ORDERS.TABLE.PLAYER' | translate }}
                    <i [class]="getSortIcon('winningPlayer')" class="ms-1"></i>
                  </th>
                  <th scope="col" class="text-center sortable-header" 
                      (click)="onSort('matchDate')"
                      [class.sorted]="isSortedBy('matchDate')">
                    {{ 'BUILD_ORDERS.TABLE.MATCH_DATE' | translate }}
                    <i [class]="getSortIcon('matchDate')" class="ms-1"></i>
                  </th>
                  <th scope="col" class="text-center sortable-header" 
                      (click)="onSort('mapType')"
                      [class.sorted]="isSortedBy('mapType')">
                    {{ 'BUILD_ORDERS.TABLE.MAP' | translate }}
                    <i [class]="getSortIcon('mapType')" class="ms-1"></i>
                  </th>
                  <th scope="col" class="text-center">{{ 'BUILD_ORDERS.TABLE.ACTIONS' | translate }}</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let match of filteredMatches; trackBy: trackByMatch">
                  <!-- Main row -->
                  <tr class="match-row">
                    <!-- Player (Avatar + Name) -->
                    <td class="leader-cell">
                      <div class="leader-info">
                        <img 
                          [src]="match.winningPlayerAvatar" 
                          [alt]="match.winningPlayer"
                          class="player-avatar"
                          (error)="onImageError($event)"
                          loading="lazy">
                        <span class="player-name clickable" 
                              (click)="onFilterByPlayer(match.winningPlayer)"
                              [title]="'Click to filter by ' + match.winningPlayer">
                          {{ match.winningPlayer }}
                        </span>
                      </div>
                    </td>
                    
                    <!-- Match Date -->
                    <td class="text-center match-date-cell">
                      <span class="match-date">{{ formatDate(match.matchDate) | date:'dd MMMM yy, HH:mm' }}</span>
                    </td>
                    
                    <!-- Map -->
                    <td class="text-center map-cell">
                      <span class="map-name clickable" 
                            (click)="onFilterByMap(match.mapType)"
                            [title]="'Click to filter by ' + formatMapName(match.mapType)">
                        {{ formatMapName(match.mapType) }}
                      </span>
                    </td>
                    
                    <!-- Actions -->
                    <td class="text-center actions-cell">
                      <div class="action-buttons">
                        <!-- If not cached, show analyze button -->
                        <ng-container *ngIf="!isReplayCached(match)">
                          <button 
                            type="button" 
                            class="btn btn-outline-primary btn-sm"
                            [disabled]="isAnalyzingReplay"
                            (click)="analyzeReplay(match)"
                            [title]="'BUILD_ORDERS.REPLAY.ANALYZE_TOOLTIP' | translate">
                            <span *ngIf="isMatchBeingAnalyzed(match.matchId)" class="spinner-border spinner-border-sm" role="status"></span>
                            <i *ngIf="!isMatchBeingAnalyzed(match.matchId)" class="fas fa-chart-line"></i>
                          </button>
                        </ng-container>

                        <!-- If cached, show action buttons based on success/error state -->
                        <ng-container *ngIf="isReplayCached(match)">
                          <!-- Download Replay File (always available) -->
                          <button 
                            type="button" 
                            class="btn btn-outline-success btn-sm me-1"
                            (click)="downloadReplayFile(match)"
                            [title]="'BUILD_ORDERS.REPLAY.DOWNLOAD_REPLAY_TOOLTIP' | translate">
                            <i class="fas fa-download"></i>
                          </button>

                          <!-- Download JSON (only if analysis was successful) -->
                          <button 
                            *ngIf="isReplayCacheSuccessful(match)"
                            type="button" 
                            class="btn btn-outline-info btn-sm me-1"
                            (click)="downloadReplayJson(match)"
                            [title]="'BUILD_ORDERS.REPLAY.DOWNLOAD_JSON_TOOLTIP' | translate">
                            <i class="fas fa-file-code"></i>
                          </button>

                          <!-- Show/Hide Timeline (only if analysis was successful) -->
                          <button 
                            *ngIf="isReplayCacheSuccessful(match)"
                            type="button" 
                            class="btn btn-sm me-1"
                            [class.btn-primary]="isRowExpanded(match)"
                            [class.btn-outline-primary]="!isRowExpanded(match)"
                            (click)="showCachedTimeline(match)"
                            [title]="(isRowExpanded(match) ? 'BUILD_ORDERS.REPLAY.HIDE_TIMELINE_TOOLTIP' : 'BUILD_ORDERS.REPLAY.SHOW_TIMELINE_TOOLTIP') | translate">
                            <i class="fas" [class.fa-chart-line]="!isRowExpanded(match)" [class.fa-eye-slash]="isRowExpanded(match)"></i>
                          </button>

                          <!-- Error indicator (only if analysis failed) -->
                          <button 
                            *ngIf="hasReplayCacheError(match)"
                            type="button" 
                            class="btn btn-outline-danger btn-sm"
                            disabled
                            [title]="'BUILD_ORDERS.REPLAY.ANALYSIS_FAILED' | translate">
                            <i class="fas fa-exclamation-triangle"></i>
                          </button>
                        </ng-container>
                      </div>
                    </td>
                  </tr>
                  
                  <!-- Timeline expansion row -->
                  <tr *ngIf="isRowExpanded(match)" class="timeline-row">
                    <td colspan="4" class="timeline-cell">
                      <div class="timeline-container">
                        <div class="timeline-header">
                          <h5 class="mb-2">
                            <i class="fas fa-chart-line me-2"></i>
                            {{ 'BUILD_ORDERS.REPLAY.WINNER_TIMELINE' | translate }}
                          </h5>
                        </div>
                        <div class="timeline-content">
                          <app-timeline 
                            [segments]="getRowTimelineData(match)"
                            [playerName]="getRowWinnerName(match)"
                            [playerColor]="getPlayerColorFromParsedData(match)"
                            [compact]="true">
                          </app-timeline>
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- Match History Table End -->

    <!-- DoD Clan Build Orders Start -->
    <div *ngIf="activeTabId === 'dod-clan-build-orders' && selectedGodId" class="tab-panel">

      <div class="match-history-section">
        <div class="section-header">
          <h3 class="section-title">{{ 'BUILD_ORDERS.DOD_CLAN.TITLE' | translate }}</h3>
          <p class="section-description">{{ 'BUILD_ORDERS.DOD_CLAN.DESCRIPTION' | translate }}</p>
        </div>
        
        <div class="dod-clan-content">
          <!-- Loading State -->
          <app-loading-state 
            *ngIf="isDodLoading"
            [message]="'BUILD_ORDERS.DOD_CLAN.LOADING' | translate">
          </app-loading-state>

          <!-- Error State -->
          <app-empty-state 
            *ngIf="!isDodLoading && dodError"
            [title]="'BUILD_ORDERS.DOD_CLAN.ERROR_TITLE' | translate"
            [description]="dodError"
            icon="fas fa-exclamation-triangle">
            <div class="empty-state-actions">
              <button 
                class="btn btn-primary"
                (click)="loadDodBuildOrders()"
                [disabled]="isDodLoading">
                <i class="fas fa-refresh me-2"></i>
                {{ 'BUILD_ORDERS.DOD_CLAN.RETRY' | translate }}
              </button>
            </div>
          </app-empty-state>

          <!-- Not Available State -->
          <app-empty-state 
            *ngIf="!isDodLoading && !dodError && !isDodGodAvailable()"
            [title]="'BUILD_ORDERS.DOD_CLAN.NOT_AVAILABLE_TITLE' | translate"
            [description]="'BUILD_ORDERS.DOD_CLAN.NOT_AVAILABLE_DESCRIPTION' | translate"
            icon="fas fa-info-circle">
            <div class="empty-state-actions">
              <p class="text-muted mb-3">{{ 'BUILD_ORDERS.DOD_CLAN.AVAILABLE_GODS' | translate }}</p>
              <div class="available-gods">
                <span 
                  *ngFor="let god of getAvailableDodGods(); let last = last"
                  class="badge badge-secondary me-1 mb-1">
                  {{ god }}{{ !last ? ',' : '' }}
                </span>
              </div>
            </div>
          </app-empty-state>

          <!-- Build Orders Content -->
          <div 
            *ngIf="!isDodLoading && !dodError && isDodGodAvailable() && dodBuildOrders.length > 0"
            class="dod-build-orders">
            
            <div class="build-orders-list">
              <div *ngFor="let buildOrder of dodBuildOrders" class="build-order-card">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                      <i class="fas fa-file-excel me-2 text-success"></i>
                      {{ buildOrder.godName }} {{ 'BUILD_ORDERS.DOD_CLAN.BUILD_ORDER' | translate }}
                    </h5>
                    <span class="badge badge-info">
                      {{ formatFileSize(buildOrder.size || 0) }}
                    </span>
                  </div>
                  
                  <div class="card-body">
                    <div class="build-order-info">
                      <div class="info-row">
                        <span class="info-label">{{ 'BUILD_ORDERS.DOD_CLAN.FILE_NAME' | translate }}:</span>
                        <span class="info-value">{{ buildOrder.fileName }}</span>
                      </div>
                      
                      <div class="info-row" *ngIf="buildOrder.lastFetched">
                        <span class="info-label">{{ 'BUILD_ORDERS.DOD_CLAN.LAST_UPDATED' | translate }}:</span>
                        <span class="info-value">{{ buildOrder.lastFetched | date:'medium' }}</span>
                      </div>
                      
                      <div class="info-row" *ngIf="buildOrder.cached">
                        <span class="info-label">{{ 'BUILD_ORDERS.DOD_CLAN.STATUS' | translate }}:</span>
                        <span class="badge badge-success">
                          <i class="fas fa-check me-1"></i>
                          {{ 'BUILD_ORDERS.DOD_CLAN.CACHED' | translate }}
                        </span>
                      </div>
                    </div>

                    <div class="build-order-actions mt-3">
                      <button 
                        class="btn btn-primary me-2"
                        (click)="downloadDodBuildOrder(buildOrder)"
                        [disabled]="!buildOrder.data">
                        <i class="fas fa-download me-2"></i>
                        {{ 'BUILD_ORDERS.DOD_CLAN.DOWNLOAD' | translate }}
                      </button>
                      
                      <button 
                        class="btn btn-outline-secondary"
                        (click)="loadDodBuildOrders()"
                        [disabled]="isDodLoading">
                        <i class="fas fa-refresh me-2"></i>
                        {{ 'BUILD_ORDERS.DOD_CLAN.REFRESH' | translate }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cache Management -->
            <div class="cache-management mt-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="card-title mb-0">
                    <i class="fas fa-database me-2"></i>
                    {{ 'BUILD_ORDERS.DOD_CLAN.CACHE_MANAGEMENT' | translate }}
                  </h6>
                </div>
                <div class="card-body">
                  <p class="text-muted mb-3">{{ 'BUILD_ORDERS.DOD_CLAN.CACHE_INFO' | translate }}</p>
                  <button 
                    class="btn btn-outline-warning"
                    (click)="clearDodCache()">
                    <i class="fas fa-trash me-2"></i>
                    {{ 'BUILD_ORDERS.DOD_CLAN.CLEAR_CACHE' | translate }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Empty State for Available God -->
          <div 
            *ngIf="!isDodLoading && !dodError && isDodGodAvailable() && dodBuildOrders.length === 0"
            class="empty-content">
            <button 
              class="btn btn-primary"
              (click)="loadDodBuildOrders()"
              [disabled]="isDodLoading">
              <i class="fas fa-download me-2"></i>
              {{ 'BUILD_ORDERS.DOD_CLAN.LOAD_BUILD_ORDERS' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- DoD Clan Build Orders End -->

  </div>
</app-page-container>
