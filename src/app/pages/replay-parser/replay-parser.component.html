<app-page-container containerClass="with-side-padding">
  <!-- Page Header -->
  <app-page-header 
    title="REPLAY_PARSER.TITLE" 
    description="REPLAY_PARSER.DESCRIPTION">
    <div class="mt-3">
      <p class="text-light">{{ 'REPLAY_PARSER.INFO.ABOUT_DESCRIPTION' | translate }}</p>
    </div>
  </app-page-header>

  <!-- File Upload Section -->
  <div class="file-upload-section mb-4">
    <div 
      class="file-drop-zone"
      [class.drag-over]="isDragOver"
      [class.has-file]="selectedFile"
      (dragover)="onDragOver($event)"
      (dragleave)="onDragLeave($event)"
      (drop)="onDrop($event)"
      (click)="fileInput.click()">
      
      <input 
        #fileInput 
        type="file" 
        accept=".mythrec,.gz,.zip"
        (change)="onFileSelected($event)"
        style="display: none;">

      <div class="drop-zone-content">
        <div *ngIf="!selectedFile" class="no-file-state">
          <i class="fas fa-cloud-upload-alt mb-3"></i>
          <h4>{{ 'REPLAY_PARSER.UPLOAD.TITLE' | translate }}</h4>
          <p>{{ 'REPLAY_PARSER.UPLOAD.DESCRIPTION' | translate }}</p>
          <p class="text-small">{{ 'REPLAY_PARSER.UPLOAD.FORMATS' | translate }}</p>
        </div>

        <div *ngIf="selectedFile" class="selected-file-state">
          <i class="fas fa-file-archive mb-3 text-success"></i>
          <h5>{{ selectedFile.name }}</h5>
          <p>{{ getFileSizeString(selectedFile.size) }}</p>
          <button 
            type="button" 
            class="btn btn-outline-warning"
            (click)="clearFile(); $event.stopPropagation()">
            <i class="fas fa-trash-alt me-2"></i>
            {{ 'REPLAY_PARSER.UPLOAD.CLEAR' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Parse Options -->
  <div *ngIf="selectedFile" class="parse-options-section mb-4">
    <h4 class="mb-3">
      <i class="fas fa-cogs me-2"></i>
      {{ 'REPLAY_PARSER.OPTIONS.TITLE' | translate }}
    </h4>

    <div class="row">
      <div class="col-md-6">
        <div class="form-check mb-3">
          <input 
            class="form-check-input" 
            type="checkbox" 
            id="slimMode"
            [(ngModel)]="parseOptions.slim">
          <label class="form-check-label" for="slimMode">
            {{ 'REPLAY_PARSER.OPTIONS.SLIM_MODE' | translate }}
            <small class="d-block">{{ 'REPLAY_PARSER.OPTIONS.SLIM_MODE_DESC' | translate }}</small>
          </label>
        </div>

        <div class="form-check mb-3">
          <input 
            class="form-check-input" 
            type="checkbox" 
            id="statsMode"
            [(ngModel)]="parseOptions.stats"
            [disabled]="parseOptions.slim">
          <label class="form-check-label" for="statsMode" [class.disabled-option]="parseOptions.slim">
            {{ 'REPLAY_PARSER.OPTIONS.STATS_MODE' | translate }}
            <small class="d-block">{{ 'REPLAY_PARSER.OPTIONS.STATS_MODE_DESC' | translate }}</small>
          </label>
        </div>

        <div class="form-check mb-3">
          <input 
            class="form-check-input" 
            type="checkbox" 
            id="prettyPrint"
            [(ngModel)]="parseOptions.prettyPrint">
          <label class="form-check-label" for="prettyPrint">
            {{ 'REPLAY_PARSER.OPTIONS.PRETTY_PRINT' | translate }}
            <small class="d-block">{{ 'REPLAY_PARSER.OPTIONS.PRETTY_PRINT_DESC' | translate }}</small>
          </label>
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-check mb-3">
          <input 
            class="form-check-input" 
            type="checkbox" 
            id="isGzip"
            [(ngModel)]="parseOptions.isGzip">
          <label class="form-check-label" for="isGzip">
            {{ 'REPLAY_PARSER.OPTIONS.GZIP_COMPRESSION' | translate }}
            <small class="d-block">{{ 'REPLAY_PARSER.OPTIONS.GZIP_COMPRESSION_DESC' | translate }}</small>
          </label>
        </div>

        <div class="form-check mb-3">
          <input 
            class="form-check-input" 
            type="checkbox" 
            id="verbose"
            [(ngModel)]="parseOptions.verbose">
          <label class="form-check-label" for="verbose">
            {{ 'REPLAY_PARSER.OPTIONS.VERBOSE_LOGGING' | translate }}
            <small class="d-block">{{ 'REPLAY_PARSER.OPTIONS.VERBOSE_LOGGING_DESC' | translate }}</small>
          </label>
        </div>
      </div>
    </div>

    <!-- Parse Button -->
    <div class="text-center mt-4">
      <button 
        type="button" 
        class="btn btn-primary btn-lg"
        [disabled]="isProcessing"
        (click)="parseReplay()">
        <span *ngIf="isProcessing" class="spinner-border spinner-border-sm me-2" role="status"></span>
        <i *ngIf="!isProcessing" class="fas fa-play me-2"></i>
        {{ (isProcessing ? 'REPLAY_PARSER.BUTTONS.PROCESSING' : 'REPLAY_PARSER.BUTTONS.PARSE') | translate }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <app-loading-state 
    *ngIf="isProcessing"
    message="REPLAY_PARSER.PROCESSING_MESSAGE">
  </app-loading-state>

  <!-- Parse Results -->
  <div *ngIf="parseResult && !isProcessing" class="parse-results-section">
    <!-- Error State -->
    <div *ngIf="!parseResult.success" class="alert alert-danger">
      <h5 class="alert-heading">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ 'REPLAY_PARSER.RESULTS.ERROR_TITLE' | translate }}
      </h5>
      <p class="mb-0">{{ parseResult.error || ('REPLAY_PARSER.RESULTS.UNKNOWN_ERROR' | translate) }}</p>
    </div>

    <!-- Success State with Detailed Results -->
    <div *ngIf="parseResult.success && parseResult.data" class="replay-analysis">
      <!-- Header with Download -->
      <div class="row mb-4">
        <div class="col-md-8">
          <h4 class="text-success mb-2">
            <i class="fas fa-check-circle me-2"></i>
            {{ 'REPLAY_PARSER.RESULTS.ANALYSIS_COMPLETE' | translate }}
          </h4>
          <p class="text-light mb-0">{{ 'REPLAY_PARSER.RESULTS.ANALYSIS_DESCRIPTION' | translate }}</p>
        </div>
        <div class="col-md-4 text-end">
          <button 
            type="button" 
            class="btn btn-outline-success"
            (click)="downloadResult()">
            <i class="fas fa-download me-2"></i>
            {{ 'REPLAY_PARSER.BUTTONS.DOWNLOAD_JSON' | translate }} ({{ getResultSizeString() }})
          </button>
        </div>
      </div>

      <!-- Game Overview -->
      <div class="row mb-4">
        <div class="col-12">
          <app-glass-card cardClass="padded">
            <h5 class="mb-3">
              <i class="fas fa-info-circle me-2" style="color: #CDA351;"></i>
              {{ 'REPLAY_PARSER.RESULTS.GAME_OVERVIEW' | translate }}
            </h5>
            <div class="row">
              <div class="col-md-3">
                <strong>{{ 'REPLAY_PARSER.RESULTS.MAP' | translate }}: </strong>{{ getMapName() || ('REPLAY_PARSER.RESULTS.UNKNOWN' | translate) }}
              </div>
              <div class="col-md-3">
                <strong>{{ 'REPLAY_PARSER.RESULTS.DURATION' | translate }}: </strong>{{ formatGameTime(parseResult.data.GameLengthSecs) }}
              </div>
              <div class="col-md-3">
                <strong>{{ 'REPLAY_PARSER.RESULTS.WINNER' | translate }}: </strong>
                {{ getWinnerNames() || ('REPLAY_PARSER.RESULTS.UNKNOWN' | translate) }}
              </div>
              <div class="col-md-3">
                <strong>{{ 'REPLAY_PARSER.RESULTS.BUILD' | translate }}: </strong>{{ parseResult.data.BuildNumber }}
              </div>
            </div>
          </app-glass-card>
        </div>
      </div>

      <!-- Players Information -->
      <div class="row mb-4">
        <div class="col-12">
          <app-glass-card cardClass="padded">
            <h5 class="mb-3">
              <i class="fas fa-users me-2" style="color: #CDA351;"></i>
              {{ 'REPLAY_PARSER.RESULTS.PLAYERS' | translate }} ({{ parseResult.data.Players?.length || 0 }})
            </h5>
            <div class="row" *ngIf="parseResult.data.Players">
              <div class="col-md-6 mb-3" *ngFor="let player of parseResult.data.Players">
                <div class="player-card p-3 border rounded">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <h6 class="mb-1" [class.text-success]="player.Winner" [class.text-light]="!player.Winner">
                        <i class="fas fa-crown me-1" *ngIf="player.Winner"></i>
                        {{ player.Name }}
                      </h6>
                      <div class="d-flex align-items-center gap-2 mb-1">
                        <small>{{ getPlayerLabel(player.PlayerNum) }} â€¢ </small>
                        <div class="major-god-display d-flex align-items-center gap-1">
                          <img *ngIf="getMajorGodIcon(player.God) as iconSrc" [src]="iconSrc" [alt]="player.God" class="major-god-icon" (error)="handleGodIconError($event)">
                          <small [class.fw-bold]="getMajorGodIcon(player.God)">{{ player.God }}</small>
                        </div>
                      </div>
                      <div class="minor-gods mt-1" *ngIf="getMinorGods(player).length > 0">
                        <small class="d-block mb-1">{{ 'REPLAY_PARSER.RESULTS.MINOR_GODS' | translate }}:</small>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                          <div class="minor-god-icon-wrapper" *ngFor="let mg of getMinorGods(player)" [title]="mg">
                            <img *ngIf="getMinorGodIcon(mg) as iconSrc" [src]="iconSrc" [alt]="mg" class="minor-god-icon" (error)="handleGodIconError($event)">
                            <span class="fallback-god-name" *ngIf="!getMinorGodIcon(mg)">{{ mg }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <span class="badge" [class.bg-success]="player.Winner" [class.bg-secondary]="!player.Winner">
                      {{ player.Winner ? ('REPLAY_PARSER.RESULTS.WINNER_BADGE' | translate) : ('REPLAY_PARSER.RESULTS.LOSER_BADGE' | translate) }}
                    </span>
                  </div>
                  <div class="player-stats">
                    <div class="row text-center">
                      <div class="col-4">
                        <small class="d-block">{{ 'REPLAY_PARSER.RESULTS.EAPM' | translate }}</small>
                        <strong>{{ roundNumber(player.EAPM) }}</strong>
                      </div>
                      <div class="col-4">
                        <small class="d-block">{{ 'REPLAY_PARSER.RESULTS.LAST_AGE' | translate }}</small>
                        <strong>{{ getLastAgeReached(player) }}</strong>
                      </div>
                      <div class="col-4">
                        <small class="d-block">{{ 'REPLAY_PARSER.RESULTS.COLOR' | translate }}</small>
                        <div class="player-color" [style.background-color]="getPlayerColor(player.Color)"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </app-glass-card>
        </div>
      </div>

      <!-- Statistics (if available) -->
      <div class="row mb-4" *ngIf="parseResult.data.Stats">
        <div class="col-12">
          <app-glass-card cardClass="padded">
            <h5 class="mb-3">
              <i class="fas fa-chart-bar me-2" style="color: #CDA351;"></i>
              {{ 'REPLAY_PARSER.RESULTS.PLAYER_STATISTICS' | translate }}
            </h5>
            <div class="row">
              <div class="col-md-6 mb-3" *ngFor="let playerStats of getPlayerStatsArray()">
                <h6>{{ getPlayerName(playerStats.playerNum) }}</h6>
                <div class="stats-grid">
                  <div class="stat-item" *ngIf="playerStats.stats.UnitCounts">
                    <small>{{ 'REPLAY_PARSER.RESULTS.UNITS_CREATED' | translate }}</small>
                    <strong>{{ getTotalCount(playerStats.stats.UnitCounts) }}</strong>
                  </div>
                  <div class="stat-item" *ngIf="playerStats.stats.BuildingCounts">
                    <small>{{ 'REPLAY_PARSER.RESULTS.BUILDINGS_BUILT' | translate }}</small>
                    <strong>{{ getTotalCount(playerStats.stats.BuildingCounts) }}</strong>
                  </div>
                  <div class="stat-item" *ngIf="playerStats.stats.TechsResearched">
                    <small>{{ 'REPLAY_PARSER.RESULTS.TECHNOLOGIES' | translate }}</small>
                    <strong>{{ playerStats.stats.TechsResearched.length }}</strong>
                  </div>
                  <div class="stat-item" *ngIf="playerStats.stats.GodPowerCounts">
                    <small>{{ 'REPLAY_PARSER.RESULTS.GOD_POWERS' | translate }}</small>
                    <strong>{{ getTotalCount(playerStats.stats.GodPowerCounts) }}</strong>
                  </div>
                </div>
              </div>
            </div>
          </app-glass-card>
        </div>
      </div>

      <!-- Timeline (up to 10 minutes) -->
      <div class="row mb-4" *ngIf="hasTimelineData()">
        <div class="col-12">
          <app-glass-card cardClass="padded">
            <h5 class="mb-3">
              <i class="fas fa-clock me-2" style="color: #CDA351;"></i>
              {{ 'REPLAY_PARSER.RESULTS.GAME_TIMELINE' | translate }}
            </h5>
            <div class="row">
              <!-- Player 1 Timeline -->
              <div class="col-md-6">
                <app-timeline
                  [playerName]="getPlayerTimelineName(1)"
                  [segments]="getTimelineDataForPlayer(1)"
                  [primaryColor]="'text-primary'"
                  [playerColor]="getPlayerColorForTimeline(1)"
                  [compact]="false">
                </app-timeline>
              </div>
              <!-- Player 2 Timeline -->
              <div class="col-md-6">
                <app-timeline
                  [playerName]="getPlayerTimelineName(2)"
                  [segments]="getTimelineDataForPlayer(2)"
                  [primaryColor]="'text-success'"
                  [playerColor]="getPlayerColorForTimeline(2)"
                  [compact]="false">
                </app-timeline>
              </div>
            </div>
          </app-glass-card>
        </div>
      </div>

    </div>
  </div>

  <!-- Features Section -->
  <div class="features-section mt-5" *ngIf="!parseResult">
    <h4 class="text-center mb-4">
      <i class="fas fa-tools me-2 text-primary"></i>
      {{ 'REPLAY_PARSER.INFO.FEATURES_TITLE' | translate }}
    </h4>

    <div class="row g-3">
      <!-- Supported Formats Card -->
      <div class="col-lg-3 col-md-6">
        <app-glass-card cardClass="padded text-center h-100">
          <i class="fas fa-file fa-2x mb-3 text-alert"></i>
          <h4>{{ 'REPLAY_PARSER.INFO.SUPPORTED_FORMATS' | translate }}</h4>
          <p class="small mb-0">.mythrec, .mythrec.gz</p>
        </app-glass-card>
      </div>
      
      <!-- Slim Mode Card -->
      <div class="col-lg-3 col-md-6">
        <app-glass-card cardClass="padded text-center h-100">
          <i class="fas fa-compress-alt fa-2x mb-3 text-success"></i>
          <h4>{{ 'REPLAY_PARSER.INFO.SLIM_MODE_TITLE' | translate }}</h4>
          <p class="small mb-0">{{ 'REPLAY_PARSER.INFO.FEATURE_SLIM' | translate }}</p>
        </app-glass-card>
      </div>
      
      <!-- Statistics Card -->
      <div class="col-lg-3 col-md-6">
        <app-glass-card cardClass="padded text-center h-100">
          <i class="fas fa-chart-bar fa-2x mb-3 text-info"></i>
          <h4>{{ 'REPLAY_PARSER.INFO.STATISTICS_TITLE' | translate }}</h4>
          <p class="small mb-0">{{ 'REPLAY_PARSER.INFO.FEATURE_STATS' | translate }}</p>
        </app-glass-card>
      </div>
      
      <!-- Pretty Print Card -->
      <div class="col-lg-3 col-md-6">
        <app-glass-card cardClass="padded text-center h-100">
          <i class="fas fa-code fa-2x mb-3 text-warning"></i>
          <h4>{{ 'REPLAY_PARSER.INFO.PRETTY_PRINT_TITLE' | translate }}</h4>
          <p class="small mb-0">{{ 'REPLAY_PARSER.INFO.FEATURE_PRETTY' | translate }}</p>
        </app-glass-card>
      </div>
    </div>
  </div>

  <!-- Empty state when no file is selected -->
  <div *ngIf="!selectedFile && !isProcessing" class="text-center mt-5">
    <app-empty-state 
      title="REPLAY_PARSER.EMPTY.TITLE" 
      description="REPLAY_PARSER.EMPTY.DESCRIPTION"
      iconClass="fas fa-file-upload">
    </app-empty-state>
  </div>
</app-page-container>